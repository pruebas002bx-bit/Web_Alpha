{% extends 'base.html' %}

{% block content %}
<style>
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
    .product-card { background: white; border: 1px solid #eee; display: flex; flex-direction: column; cursor: pointer; transition: 0.3s; position: relative; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    
    .img-box { height: 220px; display: flex; align-items: center; justify-content: center; padding: 10px; background: white; }
    .img-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    .info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
    .info h3 { font-size: 1.1rem; margin-bottom: 5px; color: #000; font-weight: 800; }
    .info .cat { color: #D32F2F; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
    
    .price-box { margin-top: auto; }
    .usd { font-size: 1.3rem; font-weight: 900; color: #D32F2F; }
    .cop { font-size: 0.9rem; color: #666; }
    
    .btn-view { background: #111; color: white; text-align: center; padding: 10px; margin-top: 10px; font-weight: bold; text-transform: uppercase; }
    .btn-view:hover { background: #D32F2F; }

    /* MODAL */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: white; width: 100%; max-width: 900px; height: 80vh; display: grid; grid-template-columns: 1fr 1fr; position: relative; border-radius: 4px; overflow: hidden; }
    .modal-left { background: #f9f9f9; padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
    .main-img { width: 100%; height: 300px; object-fit: contain; background: white; border: 1px solid #eee; margin-bottom: 15px; }
    .thumbs { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .thumb { width: 60px; height: 60px; object-fit: cover; cursor: pointer; border: 2px solid transparent; opacity: 0.6; }
    .thumb.active { border-color: #D32F2F; opacity: 1; }
    
    .modal-right { padding: 40px; overflow-y: auto; color: #333; } 
    .close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #000; z-index: 10; }
    
    @media (max-width: 768px) { .modal-content { grid-template-columns: 1fr; height: auto; max-height: 90vh; } }
</style>

<div class="grid">
    {% for p in products %}
    <article class="product-card" data-cat="{{ p.category|lower }}" onclick="openModal({{ p.id }})">
        <div class="img-box">
            <img src="{{ p.images[0] if p.images else 'https://via.placeholder.com/300' }}" alt="">
        </div>
        <div class="info">
            <span class="cat">{{ p.category }}</span>
            <h3>{{ p.name }}</h3>
            <div class="price-box">
                <div class="usd">${{ "{:,.2f}".format(p.price_usd) }}</div>
                <div class="cop">COP ${{ "{:,.0f}".format(p.price_cop) }}</div>
            </div>
            <div class="btn-view">{{ t.details }}</div>
        </div>
    </article>
    {% else %}
    <p>No hay productos.</p>
    {% endfor %}
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-left">
            <img src="" id="mImg" class="main-img">
            <div class="thumbs" id="mThumbs"></div>
        </div>
        <div class="modal-right">
            <h4 id="mCat" style="color:#D32F2F; text-transform:uppercase;"></h4>
            <h2 id="mTitle" style="font-size:2rem; margin-bottom:15px; color:#000;"></h2>
            <p id="mSpecs" style="white-space: pre-line; color:#444; margin-bottom:20px; font-size:1.1rem;"></p>
            <h3 id="mPrice" style="font-size:1.5rem; font-weight:900; color:#D32F2F;"></h3>
            <button style="background:#000; color:white; padding:15px; width:100%; border:none; margin-top:20px; font-weight:bold; cursor:pointer;">{{ t.add }}</button>
        </div>
    </div>
</div>

<script>
    // --- DICCIONARIO JS SEGURO Y ROBUSTO ---
    const productsDB = {};
    
    {% for p in products %}
    productsDB[{{ p.id }}] = {
        name: {{ p.name | tojson }},
        cat: {{ p.category | tojson }},
        specs: {{ p.specs | default('') | tojson }},
        // CORRECCIÓN AQUÍ: Usamos tojson en todo el string formateado.
        // Esto evita el error de comillas en el editor y asegura que sea un string válido JS.
        usd: {{ "{:,.2f}".format(p.price_usd) | tojson }},
        images: {{ p.images | tojson }}
    };
    {% endfor %}

    const modal = document.getElementById('modal');

    function openModal(id) {
        const p = productsDB[id];
        if(!p) return;

        document.getElementById('mTitle').innerText = p.name;
        document.getElementById('mCat').innerText = p.cat;
        document.getElementById('mSpecs').innerText = p.specs;
        document.getElementById('mPrice').innerText = `USD $${p.usd}`;

        // Lógica de Imágenes
        const mImg = document.getElementById('mImg');
        const thumbs = document.getElementById('mThumbs');
        thumbs.innerHTML = '';
        
        if(p.images && p.images.length > 0) {
            mImg.src = p.images[0];
            p.images.forEach(url => {
                const t = document.createElement('img');
                t.src = url;
                t.className = 'thumb';
                t.onclick = () => {
                    mImg.src = url;
                    document.querySelectorAll('.thumb').forEach(x => x.classList.remove('active'));
                    t.classList.add('active');
                };
                thumbs.appendChild(t);
            });
        } else {
            mImg.src = 'https://via.placeholder.com/300';
        }

        modal.style.display = 'flex';
    }

    function closeModal() { modal.style.display = 'none'; }
    window.onclick = (e) => { if(e.target == modal) closeModal(); }
</script>
{% endblock %}